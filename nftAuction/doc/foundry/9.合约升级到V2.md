# 合约升级到 V2 - 新增修改拍卖时间功能

## 一、V2 新增功能

| 功能 | 说明 | 限制 |
|------|------|------|
| `extendAuction` | 延长拍卖时间 | 仅卖家可调用 |
| `shortenAuction` | 缩短拍卖时间 | 仅卖家可调用，且无人出价 |
| `cancelAuction` | 取消拍卖 | 仅卖家可调用，且无人出价 |

## 二、升级原理

```
升级前:
┌─────────────────┐         ┌─────────────────┐
│     Proxy       │ ──────> │ Implementation  │
│  (存储数据)      │         │     V1          │
│  0xB8BbC68e...  │         │ 无修改时间功能    │
└─────────────────┘         └─────────────────┘

升级后:
┌─────────────────┐         ┌─────────────────┐
│     Proxy       │ ──────> │ Implementation  │
│  (数据不变！)    │         │     V2          │
│  0xB8BbC68e...  │         │ 有修改时间功能    │
└─────────────────┘         └─────────────────┘

关键点：
- Proxy 地址不变
- 存储的数据（拍卖信息）不变
- 只是逻辑实现更新了
- 新功能可以操作旧数据
```

## 三、升级步骤

### 3.1 环境变量

```bash
export PRIVATE_KEY="你的私钥"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_ID"
export PROXY_ADDRESS="0xB8BbC68e2f18304c4e8C77481E90164CBa17428A"
```

### 3.2 编译 V2 合约

```bash
cd /Users/kobeyang/Desktop/web3/solidity/task/nftAuction/nft
forge build
```

### 3.3 执行升级

```bash
forge script script/UpgradeToV2.s.sol:UpgradeToV2 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast \
  -vvvv
```

### 3.4 验证升级成功

```bash
# 检查版本号（应该返回 2）
cast call $PROXY_ADDRESS "VERSION()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 检查 owner 不变
cast call $PROXY_ADDRESS "owner()(address)" --rpc-url $SEPOLIA_RPC_URL

# 检查原有拍卖数据是否存在
cast call $PROXY_ADDRESS \
  "auctions(uint256)(address,address,uint256,uint256,uint256,address,uint256,uint8,address,bool)" \
  0 \
  --rpc-url $SEPOLIA_RPC_URL
```

## 四、使用新功能

### 4.1 延长拍卖时间

```bash
# 获取当前时间戳
date +%s

# 设置新的结束时间（当前时间 + 2小时）
export NEW_END_TIME=$(($(date +%s) + 7200))

# 延长拍卖（仅卖家可调用）
cast send $PROXY_ADDRESS \
  "extendAuction(uint256,uint256)" \
  0 \
  $NEW_END_TIME \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.2 缩短拍卖时间（无人出价时）

```bash
# 设置新的结束时间（当前时间 + 30分钟）
export NEW_END_TIME=$(($(date +%s) + 1800))

cast send $PROXY_ADDRESS \
  "shortenAuction(uint256,uint256)" \
  0 \
  $NEW_END_TIME \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.3 取消拍卖（无人出价时）

```bash
cast send $PROXY_ADDRESS \
  "cancelAuction(uint256)" \
  0 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.4 查询拍卖结束时间

```bash
# 返回的第5个值是 endTime
cast call $PROXY_ADDRESS \
  "auctions(uint256)(address,address,uint256,uint256,uint256,address,uint256,uint8,address,bool)" \
  0 \
  --rpc-url $SEPOLIA_RPC_URL
```

## 五、V2 函数限制说明

| 函数 | 调用者限制 | 其他限制 |
|------|-----------|---------|
| `extendAuction` | 仅卖家 | 新时间必须晚于当前结束时间 |
| `shortenAuction` | 仅卖家 | 无人出价时才能缩短 |
| `cancelAuction` | 仅卖家 | 无人出价时才能取消 |

## 六、常见问题

### Q1: 升级后原有的拍卖数据还在吗？

**在的**。数据存储在 Proxy 合约中，升级只更换逻辑实现，不影响数据。

### Q2: 升级后可以修改已有拍卖的时间吗？

**可以**。V2 的新功能可以操作所有拍卖（包括升级前创建的）。

### Q3: 升级需要重新初始化吗？

**不需要**。升级只替换逻辑，不调用 `initialize`。

### Q4: 谁可以执行升级？

只有 **owner**（合约所有者）可以调用 `upgradeToAndCall`。

### Q5: 升级失败怎么办？

升级是原子操作，失败会回滚，不会影响现有合约。

## 七、完整升级流程示例

```bash
# ============ 1. 设置环境 ============
export PRIVATE_KEY="0x..."
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/..."
export PROXY_ADDRESS="0xB8BbC68e2f18304c4e8C77481E90164CBa17428A"

# ============ 2. 升级前检查 ============
echo "升级前版本:"
cast call $PROXY_ADDRESS "VERSION()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# ============ 3. 执行升级 ============
forge script script/UpgradeToV2.s.sol:UpgradeToV2 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast -vvvv

# ============ 4. 升级后验证 ============
echo "升级后版本:"
cast call $PROXY_ADDRESS "VERSION()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# ============ 5. 测试新功能 ============
# 延长拍卖 0 的时间
export NEW_END_TIME=$(($(date +%s) + 7200))
cast send $PROXY_ADDRESS \
  "extendAuction(uint256,uint256)" 0 $NEW_END_TIME \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# 验证时间已更新
cast call $PROXY_ADDRESS \
  "auctions(uint256)(address,address,uint256,uint256,uint256,address,uint256,uint8,address,bool)" 0 \
  --rpc-url $SEPOLIA_RPC_URL
```

## 八、V1 vs V2 对比

| 功能 | V1 | V2 |
|------|----|----|
| 创建拍卖 | ✅ | ✅ |
| ETH 出价 | ✅ | ✅ |
| ERC20 出价 | ✅ | ✅ |
| 结束拍卖 | ✅ | ✅ |
| 延长时间 | ❌ | ✅ |
| 缩短时间 | ❌ | ✅ |
| 取消拍卖 | ❌ | ✅ |
| VERSION | 1 | 2 |

