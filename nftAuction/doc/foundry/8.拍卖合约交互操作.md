# NftAuctionWithOracleUpgradeable 交互操作指南

本文档介绍如何与已部署的拍卖合约进行交互。

## 前置条件

- 拍卖合约已部署并初始化
- 已有 SimpleToken (ERC20) 和 SimpleNFT (ERC721) 合约

## 合约地址

```bash
# 设置环境变量
export PRIVATE_KEY="你的私钥"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_ID"

# 合约地址
export PROXY_ADDRESS="0xB8BbC68e2f18304c4e8C77481E90164CBa17428A"  # 拍卖合约
export TOKEN_ADDRESS="0xf4AF69986484E9847F848F5c4F8686D62EBC9102"  # SimpleToken
export NFT_ADDRESS="你的NFT合约地址"
export MY_ADDRESS="0xfab857c5a4c3047abeed3F5c044f871b8633649d"
```

---

## 步骤 1: 关联代币到价格预言机

### 1.1 部署 MockPriceFeed

```bash
# 设置代币价格 $1.5 USD (Chainlink 格式: 8 位小数)
export INITIAL_PRICE=150000000
export PRICE_DESCRIPTION="STK/USD"

forge script script/DeployMockPriceFeed.s.sol:DeployMockPriceFeed \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast -vvvv
```

记录部署的 MockPriceFeed 地址：

```bash
export MOCK_PRICE_FEED="0x部署后的地址"
```

### 1.2 设置代币价格聚合器

```bash
cast send $PROXY_ADDRESS \
  "setTokenPriceFeed(address,address)" \
  $TOKEN_ADDRESS \
  $MOCK_PRICE_FEED \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 1.3 验证价格查询

```bash
# 查询 ETH 价格（18 位小数）
cast call $PROXY_ADDRESS "getEthPriceInUSD()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 查询代币价格（18 位小数）
cast call $PROXY_ADDRESS \
  "getTokenPriceInUSD(address)(uint256)" \
  $TOKEN_ADDRESS \
  --rpc-url $SEPOLIA_RPC_URL

# 100 个代币换算成美元
cast call $PROXY_ADDRESS \
  "tokenToUSD(address,uint256)(uint256)" \
  $TOKEN_ADDRESS \
  100000000000000000000 \
  --rpc-url $SEPOLIA_RPC_URL

# 0.1 ETH 换算成美元
cast call $PROXY_ADDRESS \
  "ethToUSD(uint256)(uint256)" \
  100000000000000000 \
  --rpc-url $SEPOLIA_RPC_URL
```

---

## 步骤 2: 创建拍卖

### 2.1 铸造 NFT（如果还没有）

```bash
cast send $NFT_ADDRESS \
  "safeMint(address)" \
  $MY_ADDRESS \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 2.2 授权拍卖合约转移 NFT

```bash
export TOKEN_ID=0  # 你的 NFT tokenId

cast send $NFT_ADDRESS \
  "approve(address,uint256)" \
  $PROXY_ADDRESS \
  $TOKEN_ID \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 2.3 创建拍卖

```bash
# 参数说明：
# - NFT 合约地址
# - tokenId
# - 最低出价（USD，18 位小数）：$10 = 10 * 10^18
# - 持续时间（秒）：1 小时 = 3600

cast send $PROXY_ADDRESS \
  "createAuction(address,uint256,uint256,uint256)(uint256)" \
  $NFT_ADDRESS \
  $TOKEN_ID \
  10000000000000000000 \
  3600 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 2.4 查询拍卖信息

```bash
export AUCTION_ID=0

# 查询拍卖详情
# 返回: (seller, nftAddress, tokenId, minBidUSD, endTime, highestBidder, highestBid, bidType, bidToken, settled)
cast call $PROXY_ADDRESS \
  "auctions(uint256)(address,address,uint256,uint256,uint256,address,uint256,uint8,address,bool)" \
  $AUCTION_ID \
  --rpc-url $SEPOLIA_RPC_URL
```

---

## 步骤 3: 出价

### 3.1 使用 ETH 出价

```bash
# 出价 0.05 ETH
cast send $PROXY_ADDRESS \
  "bidWithETH(uint256)" \
  $AUCTION_ID \
  --value 50000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 3.2 查询当前最高出价

```bash
# 返回美元价值（18 位小数）
cast call $PROXY_ADDRESS \
  "getAuctionHighestBidUSD(uint256)(uint256)" \
  $AUCTION_ID \
  --rpc-url $SEPOLIA_RPC_URL
```

### 3.3 使用 ERC20 代币出价

```bash
# 先授权拍卖合约使用代币
cast send $TOKEN_ADDRESS \
  "approve(address,uint256)" \
  $PROXY_ADDRESS \
  1000000000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL

# 出价 200 个代币
cast send $PROXY_ADDRESS \
  "bidWithERC20(uint256,address,uint256)" \
  $AUCTION_ID \
  $TOKEN_ADDRESS \
  200000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 3.4 出价规则

- 出价必须 ≥ 最低出价（minBidUSD）
- 新出价必须 > 当前最高出价（USD 价值）
- 被超越的出价会自动退还给原出价者

---

## 步骤 4: 结束拍卖

### 4.1 检查拍卖是否结束

```bash
# 查询拍卖信息，第5个返回值是 endTime
cast call $PROXY_ADDRESS \
  "auctions(uint256)(address,address,uint256,uint256,uint256,address,uint256,uint8,address,bool)" \
  $AUCTION_ID \
  --rpc-url $SEPOLIA_RPC_URL

# 查询当前区块时间
cast block latest --rpc-url $SEPOLIA_RPC_URL | grep timestamp
```

### 4.2 结束拍卖

```bash
# 必须在 endTime 之后调用
cast send $PROXY_ADDRESS \
  "endAuction(uint256)" \
  $AUCTION_ID \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.3 结果

- **有人出价**：NFT 转给最高出价者，资金转给卖家
- **无人出价**：NFT 退还给卖家

---

## 完整流程示例

```bash
# ============ 环境配置 ============
export PRIVATE_KEY="0x..."
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/..."
export PROXY_ADDRESS="0xB8BbC68e2f18304c4e8C77481E90164CBa17428A"
export TOKEN_ADDRESS="0xf4AF69986484E9847F848F5c4F8686D62EBC9102"
export NFT_ADDRESS="0x..."
export MOCK_PRICE_FEED="0x..."

# ============ 1. 设置代币价格聚合器 ============
cast send $PROXY_ADDRESS \
  "setTokenPriceFeed(address,address)" \
  $TOKEN_ADDRESS $MOCK_PRICE_FEED \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# ============ 2. 创建拍卖 ============
# 授权 NFT
cast send $NFT_ADDRESS "approve(address,uint256)" $PROXY_ADDRESS 0 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# 创建拍卖（$100 起拍，1小时）
cast send $PROXY_ADDRESS \
  "createAuction(address,uint256,uint256,uint256)(uint256)" \
  $NFT_ADDRESS 0 100000000000000000000 3600 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# ============ 3. ETH 出价 ============
cast send $PROXY_ADDRESS "bidWithETH(uint256)" 0 \
  --value 50000000000000000 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# ============ 4. ERC20 出价（更高价） ============
# 授权代币
cast send $TOKEN_ADDRESS "approve(address,uint256)" $PROXY_ADDRESS 1000000000000000000000000 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# 出价 200 代币
cast send $PROXY_ADDRESS \
  "bidWithERC20(uint256,address,uint256)" 0 $TOKEN_ADDRESS 200000000000000000000 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL

# ============ 5. 查询最高出价 ============
cast call $PROXY_ADDRESS "getAuctionHighestBidUSD(uint256)(uint256)" 0 --rpc-url $SEPOLIA_RPC_URL

# ============ 6. 结束拍卖（等待时间到期后） ============
cast send $PROXY_ADDRESS "endAuction(uint256)" 0 \
  --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL
```

---

## 常见问题

### Q1: "Bid below minimum" 错误

出价的美元价值低于最低出价（minBidUSD），需要增加出价金额。

### Q2: "Bid too low" 错误

出价低于当前最高出价，需要出更高的价。

### Q3: "Auction not yet ended" 错误

拍卖还没到结束时间，需要等待。

### Q4: "Token price feed not set" 错误

代币没有设置价格聚合器，需要先调用 `setTokenPriceFeed`。

### Q5: 如何计算出价金额？

```
ETH 出价：
  需要的美元价值 / ETH 价格 = ETH 数量
  例如：$150 / $3000 = 0.05 ETH

代币出价：
  需要的美元价值 / 代币价格 = 代币数量
  例如：$150 / $1.5 = 100 代币
```

