# 价格预言机部署与交互脚本

## 目录

- [概述](#概述)
- [环境准备](#环境准备)
- [部署脚本说明](#部署脚本说明)
- [本地部署（Anvil）](#本地部署anvil)
- [部署到 Sepolia 测试网](#部署到-sepolia-测试网)
- [交互脚本（Cast）](#交互脚本cast)
- [常见问题](#常见问题)

---

## 概述

本文档介绍如何使用 Foundry 部署 `PriceOracleOfficial` 合约，并提供完整的交互脚本示例。

### 文件结构

```
nftAuction/nft/
├── script/
│   └── DeployPriceOracle.s.sol    # 部署脚本
├── src/
│   └── PriceOracleOfficial.sol    # 价格预言机合约
└── doc/foundry/
    └── 3.价格预言机部署与交互脚本.md  # 本文档
```

---

## 环境准备

### 1. 安装 Foundry

如果还没有安装 Foundry：

```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

### 2. 配置环境变量

创建 `.env` 文件（可选，也可以直接 export）：

```bash
# .env 文件
PRIVATE_KEY=0x你的私钥（不要泄露主网私钥）
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_INFURA_ID
# 或者使用 Alchemy
# SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
ETHERSCAN_API_KEY=YOUR_ETHERSCAN_API_KEY
ETH_USD_PRICE_FEED=0x694AA1769357215DE4FAC081bf1f309aDC325306  # Sepolia ETH/USD
```

或者直接 export：

```bash
export PRIVATE_KEY="0x你的私钥"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_INFURA_ID"
export ETHERSCAN_API_KEY="YOUR_ETHERSCAN_API_KEY"
export ETH_USD_PRICE_FEED="0x694AA1769357215DE4FAC081bf1f309aDC325306"
```

### 3. 获取测试网 ETH

部署到 Sepolia 需要测试网 ETH，可以从以下水龙头获取：

- [Alchemy Sepolia Faucet](https://sepoliafaucet.com/)
- [Infura Sepolia Faucet](https://www.infura.io/faucet/sepolia)
- [Chainlink Faucet](https://faucets.chain.link/sepolia)

### 4. 价格聚合器地址

#### Sepolia 测试网

| 资产对 | 聚合器地址 |
|--------|-----------|
| ETH/USD | `0x694AA1769357215DE4FAC081bf1f309aDC325306` |
| BTC/USD | `0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43` |

#### 以太坊主网（参考）

| 资产对 | 聚合器地址 |
|--------|-----------|
| ETH/USD | `0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419` |
| BTC/USD | `0xF4030086522a5bEEa4988F8cA5B36dbC97BeE88c` |
| USDC/USD | `0x8fFfFfd4AfB6115b04Bd6860E2415C89C1C7C4b8` |

**注意：** 价格聚合器地址可能更新，请访问 [Chainlink 官方文档](https://docs.chain.link/data-feeds/price-feeds/addresses) 获取最新地址。

---

## 部署脚本说明

### 脚本位置

`script/DeployPriceOracle.s.sol`

### 脚本功能

1. 从环境变量读取部署者私钥
2. 从环境变量读取 ETH/USD 价格聚合器地址（默认使用 Sepolia）
3. 部署 `PriceOracleOfficial` 合约
4. 打印部署信息

### 脚本代码

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Script.sol";
import "../src/PriceOracleOfficial.sol";

contract DeployPriceOracle is Script {
    // Sepolia 测试网 ETH/USD 价格聚合器地址
    address constant SEPOLIA_ETH_USD_FEED = 0x694AA1769357215DE4FAC081bf1f309aDC325306;

    function run() external returns (PriceOracleOfficial) {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address ethUsdPriceFeed = vm.envOr("ETH_USD_PRICE_FEED", SEPOLIA_ETH_USD_FEED);

        vm.startBroadcast(deployerPrivateKey);
        PriceOracleOfficial oracle = new PriceOracleOfficial(ethUsdPriceFeed);
        vm.stopBroadcast();

        console2.log("PriceOracleOfficial deployed at:", address(oracle));
        return oracle;
    }
}
```

---

## 本地部署（Anvil）

### 步骤 1：启动本地节点

```bash
# 终端 1：启动 Anvil
anvil
```

输出示例：
```
Available Accounts
==================
(0) 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
...

Private Keys
==================
(0) 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
...
```

### 步骤 2：编译合约

```bash
cd /Users/kobeyang/Desktop/web3/solidity/task/nftAuction/nft
forge build
```

### 步骤 3：部署到本地节点

```bash
# 使用 Anvil 的默认账户
forge script script/DeployPriceOracle.s.sol:DeployPriceOracle \
  --rpc-url http://127.0.0.1:8545 \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  --broadcast \
  -vvvv
```

**注意：** 本地部署时，需要使用一个模拟的价格聚合器地址，或者部署一个 Mock 价格聚合器。

---

## 部署到 Sepolia 测试网

### 步骤 1：设置环境变量

**必需的环境变量：**
```bash
export PRIVATE_KEY="0x你的私钥"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_INFURA_ID"
# 或者
export SEPOLIA_RPC_URL="https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY"
export ETHERSCAN_API_KEY="YOUR_ETHERSCAN_API_KEY"
```

**可选的环境变量（用于初始化）：**
```bash
# ETH/USD 价格聚合器地址（默认使用 Sepolia）
export ETH_USD_PRICE_FEED="0x694AA1769357215DE4FAC081bf1f309aDC325306"

# 价格过期阈值（秒，默认 3600 = 1 小时）
export STALE_PRICE_THRESHOLD="7200"  # 2 小时

# 设置代币价格聚合器（可选）
# 例如：设置 BTC/USD
export BTC_TOKEN_ADDRESS="0xYourBTCTokenAddress"
export BTC_USD_PRICE_FEED="0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43"
```

### 步骤 2：编译合约

```bash
cd /Users/kobeyang/Desktop/web3/solidity/task/nftAuction/nft
forge build
```

### 步骤 3：部署到 Sepolia

```bash
forge script script/DeployPriceOracle.s.sol:DeployPriceOracle \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast \
  --verify \
  -vvvv
```

**参数说明：**
- `--rpc-url $SEPOLIA_RPC_URL`：Sepolia 测试网 RPC 端点
- `--private-key $PRIVATE_KEY`：部署者私钥
- `--broadcast`：实际发送交易到区块链
- `--verify`：自动在 Etherscan 上验证合约源码
- `-vvvv`：输出详细日志

### 步骤 4：查看部署和初始化结果

部署成功后，你会看到类似输出：

```
==========================================
Step 1: Deploying PriceOracleOfficial...
Deployer: 0xYourAddress
ETH/USD Price Feed: 0x694AA1769357215DE4FAC081bf1f309aDC325306
==========================================
==========================================
Step 2: Initializing contract...
==========================================
2.1 Verifying deployment...
   [OK] Contract deployed successfully
   [OK] Owner verified: 0xYourAddress
2.2 Verifying ETH price feed...
   [OK] ETH price feed working
   [OK] ETH price: 3000500000000000000000
2.3 Using default stale price threshold (3600 seconds)
2.4 Skipping token price feed setup (set BTC_TOKEN_ADDRESS and BTC_USD_PRICE_FEED to enable)
2.5 Verifying price feed info...
   [OK] Price feed decimals: 8
   [OK] Price feed description: ETH / USD
   [OK] Price feed version: 3
==========================================
Deployment and Initialization Complete!
==========================================
Contract Address: 0xYourContractAddress
Owner: 0xYourAddress
ETH/USD Price Feed: 0x694AA1769357215DE4FAC081bf1f309aDC325306
Stale Price Threshold: 3600 seconds
==========================================
```

### 初始化步骤说明

部署脚本会自动执行以下初始化步骤：

#### 步骤 2.1：验证部署
- ✅ 检查合约地址是否有效（非零地址）
- ✅ 验证合约所有者是否为部署者
- ✅ 确保合约已正确部署

#### 步骤 2.2：验证 ETH 价格查询
- ✅ 调用 `getEthPriceInUSD()` 测试价格聚合器
- ✅ 验证返回的价格是否大于 0
- ⚠️ 在本地网络（Anvil）上可能失败，这是正常的

#### 步骤 2.3：设置价格过期阈值
- 默认值：3600 秒（1 小时）
- 可通过环境变量 `STALE_PRICE_THRESHOLD` 自定义
- 如果设置为非默认值，会自动调用 `setStalePriceThreshold()`

**示例：**
```bash
# 设置 2 小时过期阈值
export STALE_PRICE_THRESHOLD="7200"
```

#### 步骤 2.4：设置代币价格聚合器（可选）
- 如果设置了 `BTC_TOKEN_ADDRESS` 和 `BTC_USD_PRICE_FEED` 环境变量
- 会自动调用 `setTokenPriceFeed()` 设置 BTC/USD 价格聚合器
- 可以扩展支持更多代币

**示例：**
```bash
# 设置 BTC/USD 价格聚合器
export BTC_TOKEN_ADDRESS="0xYourBTCTokenAddress"
export BTC_USD_PRICE_FEED="0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43"
```

#### 步骤 2.5：验证价格聚合器信息
- ✅ 获取价格聚合器的精度（decimals）
- ✅ 获取价格聚合器的描述（description）
- ✅ 获取价格聚合器的版本（version）
- 用于确认价格聚合器配置正确

### 初始化后的验证

部署和初始化完成后，建议执行以下验证：

**重要：** 首先设置合约地址环境变量！

```bash
# 设置合约地址（从部署输出中获取）
export CONTRACT_ADDRESS="0xYourContractAddress"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_INFURA_ID"

# 1. 查询 ETH 价格
cast call $CONTRACT_ADDRESS "getEthPriceInUSD()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 2. 查询合约所有者
cast call $CONTRACT_ADDRESS "owner()(address)" --rpc-url $SEPOLIA_RPC_URL

# 3. 查询价格过期阈值
cast call $CONTRACT_ADDRESS "stalePriceThreshold()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 4. 查询价格聚合器信息
cast call $CONTRACT_ADDRESS "getEthPriceFeedInfo()(uint8,string,uint256)" --rpc-url $SEPOLIA_RPC_URL
```

**或者直接使用合约地址（不使用变量）：**

```bash
# 直接使用合约地址
cast call 0xYourContractAddress "getEthPriceInUSD()(uint256)" --rpc-url $SEPOLIA_RPC_URL
```

### 步骤 5：在 Etherscan 查看合约

访问 [Sepolia Etherscan](https://sepolia.etherscan.io/) 并搜索你的合约地址，可以查看：
- 合约代码（如果验证成功）
- 交易历史
- 合约状态

---

## 交互脚本（Cast）

使用 Foundry 的 `cast` 工具与部署的合约交互。

### 前提条件

**重要：** 在使用 `cast call` 之前，必须设置合约地址！

```bash
# 方式 1: 设置环境变量
export CONTRACT_ADDRESS="0xYourContractAddress"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_INFURA_ID"

# 方式 2: 直接使用地址（推荐，避免变量未设置的问题）
# 在下面的命令中，将 0xYourContractAddress 替换为你的实际合约地址
```

假设你已经部署了合约，合约地址为：`0xYourContractAddress`

### 1. 查询 ETH 价格（8 位小数）

```bash
# 方式 1: 使用环境变量（确保已设置）
cast call $CONTRACT_ADDRESS \
  "getEthPrice()(int256)" \
  --rpc-url $SEPOLIA_RPC_URL

# 方式 2: 直接使用地址（推荐）
cast call 0xYourContractAddress \
  "getEthPrice()(int256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

**输出示例：**
```
300050000000  # 表示 $3000.50
```

### 2. 查询 ETH 价格（18 位小数）

```bash
# 获取 ETH 价格（返回 uint256，18 位小数）
# 注意：将 0xYourContractAddress 替换为你的实际合约地址
cast call 0xYourContractAddress \
  "getEthPriceInUSD()(uint256)" \
  --rpc-url $SEPOLIA_RPC_URL

# 或者使用环境变量（如果已设置）
# cast call $CONTRACT_ADDRESS "getEthPriceInUSD()(uint256)" --rpc-url $SEPOLIA_RPC_URL
```

**输出示例：**
```
3000500000000000000000  # 表示 $3000.50（18 位小数）
```

### 3. 将 ETH 数量转换为美元

```bash
# 将 1 ETH 转换为美元价值
cast call 0xYourContractAddress \
  "ethToUSD(uint256)(uint256)" \
  1000000000000000000 \
  --rpc-url $SEPOLIA_RPC_URL
```

**参数说明：**
- `1000000000000000000` = 1 ETH（1e18 Wei）

### 4. 获取价格聚合器信息

```bash
# 获取 ETH 价格聚合器的详细信息
cast call 0xYourContractAddress \
  "getEthPriceFeedInfo()(uint8,string,uint256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

**输出示例：**
```
8
ETH / USD
3
```

### 5. 设置 ERC20 代币价格聚合器（需要 Owner）

```bash
# 设置 USDC/USD 价格聚合器
# Sepolia USDC/USD: 0xA2F78ab2355fe2f984D808B5CeE7FD6A2bD5F3d5
cast send 0xYourContractAddress \
  "setTokenPriceFeed(address,address)" \
  0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 \
  0xA2F78ab2355fe2f984D808B5CeE7FD6A2bD5F3d5 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY
```

### 6. 查询代币价格

```bash
# 查询 USDC 价格（需要先设置价格聚合器）
cast call 0xYourContractAddress \
  "getTokenPriceInUSD(address)(uint256)" \
  0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 \
  --rpc-url $SEPOLIA_RPC_URL
```

### 7. 获取 ETH 和代币价格（批量查询）

```bash
# 同时获取 ETH 和 USDC 价格
cast call 0xYourContractAddress \
  "getPrices(address)(uint256,uint256,uint256,uint256)" \
  0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 \
  --rpc-url $SEPOLIA_RPC_URL
```

**返回值：**
- `ethPrice`: ETH 价格（18 位小数）
- `tokenPrice`: 代币价格（18 位小数）
- `ethUpdatedAt`: ETH 价格更新时间戳
- `tokenUpdatedAt`: 代币价格更新时间戳

### 8. 查询合约所有者

```bash
cast call 0xYourContractAddress \
  "owner()(address)" \
  --rpc-url $SEPOLIA_RPC_URL
```

### 9. 查询价格过期阈值

```bash
cast call 0xYourContractAddress \
  "stalePriceThreshold()(uint256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

### 10. 设置价格过期阈值（需要 Owner）

```bash
# 设置价格为 2 小时过期（7200 秒）
cast send 0xYourContractAddress \
  "setStalePriceThreshold(uint256)" \
  7200 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY
```

---

## 完整交互示例脚本

创建一个交互脚本文件 `interact.sh`：

```bash
#!/bin/bash

# 配置
CONTRACT_ADDRESS="0xYourContractAddress"
RPC_URL="${SEPOLIA_RPC_URL:-https://sepolia.infura.io/v3/YOUR_INFURA_ID}"
PRIVATE_KEY="${PRIVATE_KEY:-0xYourPrivateKey}"

echo "=========================================="
echo "PriceOracle 交互脚本"
echo "合约地址: $CONTRACT_ADDRESS"
echo "=========================================="

# 1. 查询 ETH 价格（8 位小数）
echo ""
echo "1. 查询 ETH 价格（8 位小数）:"
cast call $CONTRACT_ADDRESS \
  "getEthPrice()(int256)" \
  --rpc-url $RPC_URL

# 2. 查询 ETH 价格（18 位小数）
echo ""
echo "2. 查询 ETH 价格（18 位小数）:"
cast call $CONTRACT_ADDRESS \
  "getEthPriceInUSD()(uint256)" \
  --rpc-url $RPC_URL

# 3. 将 1 ETH 转换为美元
echo ""
echo "3. 将 1 ETH 转换为美元:"
cast call $CONTRACT_ADDRESS \
  "ethToUSD(uint256)(uint256)" \
  1000000000000000000 \
  --rpc-url $RPC_URL

# 4. 获取价格聚合器信息
echo ""
echo "4. 获取价格聚合器信息:"
cast call $CONTRACT_ADDRESS \
  "getEthPriceFeedInfo()(uint8,string,uint256)" \
  --rpc-url $RPC_URL

# 5. 查询合约所有者
echo ""
echo "5. 查询合约所有者:"
cast call $CONTRACT_ADDRESS \
  "owner()(address)" \
  --rpc-url $RPC_URL

# 6. 查询价格过期阈值
echo ""
echo "6. 查询价格过期阈值:"
cast call $CONTRACT_ADDRESS \
  "stalePriceThreshold()(uint256)" \
  --rpc-url $RPC_URL

echo ""
echo "=========================================="
echo "交互完成"
echo "=========================================="
```

**使用方法：**

```bash
chmod +x interact.sh
./interact.sh
```

---

## 常见问题

### Q1: `cast call` 报错 "odd number of digits" 或 "invalid value"

**错误信息：**
```
error: invalid value 'getEthPriceInUSD()(uint256)' for '[TO]': odd number of digits
```

**原因：**
- `$CONTRACT_ADDRESS` 环境变量未设置或为空
- `cast` 将函数签名误认为是地址

**解决方案：**

1. **检查环境变量是否设置：**
```bash
echo $CONTRACT_ADDRESS
# 如果输出为空，需要设置：
export CONTRACT_ADDRESS="0xYourContractAddress"
```

2. **直接使用合约地址（推荐）：**
```bash
# 不要使用变量，直接写地址
cast call 0xYourContractAddress "getEthPriceInUSD()(uint256)" --rpc-url $SEPOLIA_RPC_URL
```

3. **确保地址格式正确：**
```bash
# 地址必须是 42 个字符（包括 0x 前缀）
# 正确: 0x1234567890123456789012345678901234567890
# 错误: 1234567890123456789012345678901234567890 (缺少 0x)
```

4. **完整的正确命令格式：**
```bash
# 格式: cast call <合约地址> "<函数签名>" [参数...] --rpc-url <RPC_URL>
cast call 0xYourContractAddress \
  "getEthPriceInUSD()(uint256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

### Q2: 查询价格时提示 "Price too stale"

**错误信息：**
```
Error: execution reverted: Price too stale
```

**原因：**
- **阈值设置过小**：`stalePriceThreshold`（默认 3600 秒 = 1 小时）小于价格聚合器的实际更新频率
- **更新频率关系**：阈值必须 **≥ 价格聚合器的更新频率**
- Sepolia 测试网上的价格聚合器更新频率可能比主网慢（可能 2-4 小时更新一次）
- 价格聚合器可能暂时停止更新

**重要理解：**

```
价格过期阈值 (stalePriceThreshold) ≥ 价格聚合器更新频率
```

**示例：**
- 如果价格聚合器每 2 小时更新一次，阈值应该设置为 ≥ 7200 秒（2 小时）
- 如果价格聚合器每 1 小时更新一次，阈值设置为 3600 秒（1 小时）即可
- 如果阈值设置为 1 小时，但价格聚合器 2 小时才更新一次，就会一直报错

**解决方案：**

1. **增加价格过期阈值（推荐）：**
```bash
# 设置为 24 小时（86400 秒）
cast send 0xYourContractAddress \
  "setStalePriceThreshold(uint256)" \
  86400 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY
```

2. **检查价格聚合器的更新频率：**
```bash
# 查询价格聚合器的最新数据，包括更新时间
cast call 0x694AA1769357215DE4FAC081bf1f309aDC325306 \
  "latestRoundData()(uint80,int256,uint256,uint256,uint80)" \
  --rpc-url $SEPOLIA_RPC_URL

# 输出示例：
# roundId: 18446744073709551615
# price: 300050000000
# startedAt: 0
# updatedAt: 1734567890  # 这是最后更新时间戳（Unix 时间戳）
# answeredInRound: 18446744073709551615
```

**计算价格更新时间：**
```bash
# 获取当前时间戳
date +%s

# 计算时间差（秒）
# 当前时间戳 - updatedAt = 价格已过时间（秒）
# 如果这个值 > stalePriceThreshold，就会报错
```

**判断更新频率：**
- 多次查询 `updatedAt`，观察时间间隔
- 如果 `updatedAt` 每 2 小时变化一次，说明更新频率是 2 小时
- 阈值应该设置为 ≥ 2 小时（7200 秒）

3. **查询当前阈值：**
```bash
cast call 0xYourContractAddress \
  "stalePriceThreshold()(uint256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

4. **临时解决方案（仅用于测试）：**
   - 在部署时设置更大的阈值：
   ```bash
   export STALE_PRICE_THRESHOLD="86400"  # 24 小时
   ```

**如何选择合适的阈值：**

1. **查询价格聚合器的更新频率：**
   ```bash
   # 多次查询 updatedAt，观察更新间隔
   cast call 0x694AA1769357215DE4FAC081bf1f309aDC325306 \
     "latestRoundData()(uint80,int256,uint256,uint256,uint80)" \
     --rpc-url $SEPOLIA_RPC_URL
   ```

2. **设置阈值规则：**
   - **最小值**：阈值 ≥ 价格聚合器更新频率
   - **推荐值**：阈值 = 更新频率 × 1.5 到 2 倍（留出缓冲）
   - **测试网**：可以设置更大（如 24 小时 = 86400 秒）
   - **主网**：根据实际需求，通常 1-4 小时

3. **示例：**
   ```
   价格聚合器更新频率：2 小时
   推荐阈值：3-4 小时（10800-14400 秒）
   
   价格聚合器更新频率：1 小时
   推荐阈值：1.5-2 小时（5400-7200 秒）
   ```

**注意：** 
- 在生产环境中，应该根据实际需求设置合理的阈值
- 测试网上可以设置更大的值（如 24 小时）
- 阈值设置过大会降低安全性（可能使用过时价格）
- 阈值设置过小会导致频繁报错

### Q3: 部署失败，提示 "Insufficient funds"

**原因：** 账户余额不足，无法支付 Gas 费用。

**解决方案：**
1. 检查账户是否有足够的 Sepolia ETH
2. 从水龙头获取测试网 ETH
3. 检查 `PRIVATE_KEY` 是否正确

### Q2: 价格查询返回 0 或错误

**原因：**
- 价格聚合器地址不正确
- 价格聚合器在测试网上可能未激活
- 价格数据过期

**解决方案：**
1. 确认使用正确的价格聚合器地址
2. 检查价格聚合器是否在目标网络上可用
3. 检查价格更新时间是否在阈值内

### Q3: 验证合约失败

**原因：**
- Etherscan API Key 不正确
- 合约代码与部署的字节码不匹配
- 网络问题

**解决方案：**
1. 检查 `ETHERSCAN_API_KEY` 是否正确
2. 确保合约代码已编译
3. 手动验证：访问 Etherscan，选择 "Verify and Publish"

### Q4: 如何在不同网络部署？

**修改价格聚合器地址：**

```bash
# 以太坊主网
export ETH_USD_PRICE_FEED="0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419"

# Sepolia 测试网
export ETH_USD_PRICE_FEED="0x694AA1769357215DE4FAC081bf1f309aDC325306"
```

### Q5: 如何添加更多代币价格源？

```bash
# 1. 设置代币价格聚合器（需要 Owner）
cast send 0xYourContractAddress \
  "setTokenPriceFeed(address,address)" \
  0x代币地址 \
  0x价格聚合器地址 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY

# 2. 查询代币价格
cast call 0xYourContractAddress \
  "getTokenPriceInUSD(address)(uint256)" \
  0x代币地址 \
  --rpc-url $SEPOLIA_RPC_URL
```

---

## 总结

通过本文档，你可以：

1. ✅ **部署价格预言机**到本地或 Sepolia 测试网
2. ✅ **查询 ETH 价格**（8 位和 18 位小数）
3. ✅ **转换 ETH 到美元**价值
4. ✅ **设置代币价格源**并查询代币价格
5. ✅ **管理合约配置**（价格过期阈值等）

**下一步：**
- 将价格预言机集成到你的 DeFi 应用中
- 在拍卖合约中使用价格信息
- 实现基于价格的清算机制

祝你部署顺利！🚀

