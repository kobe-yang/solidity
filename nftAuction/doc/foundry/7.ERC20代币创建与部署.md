# ERC20 代币创建与部署

本文档介绍如何使用 OpenZeppelin 创建和部署 ERC20 代币。

## 一、合约功能

`SimpleToken` 继承了以下 OpenZeppelin 合约：

| 合约 | 功能 |
|------|------|
| `ERC20` | 标准 ERC20 实现（转账、余额、授权） |
| `ERC20Burnable` | 支持销毁代币 |
| `ERC20Permit` | 支持 EIP-2612 签名授权（无需 approve 交易） |
| `Ownable` | 权限控制（只有 owner 可以铸造） |

## 二、合约代码

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "openzeppelin/contracts/token/ERC20/ERC20.sol";
import "openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol";
import "openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol";
import "openzeppelin/contracts/access/Ownable.sol";

contract SimpleToken is ERC20, ERC20Burnable, ERC20Permit, Ownable {
    
    constructor(
        string memory name,
        string memory symbol,
        uint256 initialSupply
    ) ERC20(name, symbol) ERC20Permit(name) Ownable(msg.sender) {
        _mint(msg.sender, initialSupply * 10 ** decimals());
    }
    
    function mint(address to, uint256 amount) external onlyOwner {
        _mint(to, amount);
    }
}
```

## 三、部署步骤

### 3.1 环境变量配置

```bash
# 必需
export PRIVATE_KEY="0x你的私钥"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_ID"

# 可选（代币参数）
export TOKEN_NAME="My Token"
export TOKEN_SYMBOL="MTK"
export INITIAL_SUPPLY=1000000  # 初始供应量（会自动乘以 10^18）
```

### 3.2 编译

```bash
cd /Users/kobeyang/Desktop/web3/solidity/task/nftAuction/nft
forge build
```

### 3.3 部署到 Sepolia

```bash
forge script script/DeploySimpleToken.s.sol:DeploySimpleToken \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast \
  -vvvv
```

### 3.4 部署并验证

```bash
forge script script/DeploySimpleToken.s.sol:DeploySimpleToken \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY \
  -vvvv
```

## 四、交互命令

### 4.1 查询代币信息

```bash
# 设置代币地址
export TOKEN_ADDRESS="0x部署后的地址"

# 查询名称
cast call $TOKEN_ADDRESS "name()(string)" --rpc-url $SEPOLIA_RPC_URL

# 查询符号
cast call $TOKEN_ADDRESS "symbol()(string)" --rpc-url $SEPOLIA_RPC_URL

# 查询总供应量
cast call $TOKEN_ADDRESS "totalSupply()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 查询余额
cast call $TOKEN_ADDRESS "balanceOf(address)(uint256)" $YOUR_ADDRESS --rpc-url $SEPOLIA_RPC_URL

# 查询精度
cast call $TOKEN_ADDRESS "decimals()(uint8)" --rpc-url $SEPOLIA_RPC_URL
```

### 4.2 转账

```bash
# 转账 100 个代币（注意要乘以 10^18）
cast send $TOKEN_ADDRESS \
  "transfer(address,uint256)(bool)" \
  $RECIPIENT_ADDRESS \
  100000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.3 授权

```bash
# 授权 spender 使用 1000 个代币
cast send $TOKEN_ADDRESS \
  "approve(address,uint256)(bool)" \
  $SPENDER_ADDRESS \
  1000000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL

# 查询授权额度
cast call $TOKEN_ADDRESS \
  "allowance(address,address)(uint256)" \
  $OWNER_ADDRESS \
  $SPENDER_ADDRESS \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.4 铸造（仅 owner）

```bash
# 铸造 10000 个代币给指定地址
cast send $TOKEN_ADDRESS \
  "mint(address,uint256)" \
  $RECIPIENT_ADDRESS \
  10000000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.5 销毁

```bash
# 销毁自己的 100 个代币
cast send $TOKEN_ADDRESS \
  "burn(uint256)" \
  100000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

## 五、与拍卖合约集成

### 5.1 设置价格聚合器

如果要在拍卖合约中使用此代币，需要设置价格聚合器：

```bash
# 部署 MockPriceFeed（测试网）
forge script script/DeployMockPriceFeed.s.sol:DeployMockPriceFeed \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast

# 在拍卖合约中设置代币价格聚合器
cast send $AUCTION_CONTRACT \
  "setTokenPriceFeed(address,address)" \
  $TOKEN_ADDRESS \
  $MOCK_PRICE_FEED_ADDRESS \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

### 5.2 授权拍卖合约

```bash
# 授权拍卖合约使用代币
cast send $TOKEN_ADDRESS \
  "approve(address,uint256)(bool)" \
  $AUCTION_CONTRACT \
  115792089237316195423570985008687907853269984665640564039457584007913129639935 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

## 六、常见问题

### Q1: decimals 是什么？

ERC20 代币默认 18 位小数，1 个代币 = 10^18 最小单位（类似 ETH 和 Wei）。

### Q2: 如何计算实际代币数量？

```
实际代币数 = 链上数值 / 10^18

例如：1000000000000000000 = 1 个代币
```

### Q3: Permit 有什么用？

允许用户通过签名授权，而不需要发送 approve 交易，节省 Gas。

### Q4: 如何增发代币？

只有 owner 可以调用 `mint` 函数增发。

## 七、完整示例流程

```bash
# 1. 设置环境变量
export PRIVATE_KEY="0x..."
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/..."
export TOKEN_NAME="Test Token"
export TOKEN_SYMBOL="TTK"
export INITIAL_SUPPLY=1000000

# 2. 部署
forge script script/DeploySimpleToken.s.sol:DeploySimpleToken \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast -vvvv

# 3. 记录地址
export TOKEN_ADDRESS="0x..."

# 4. 验证部署
cast call $TOKEN_ADDRESS "name()(string)" --rpc-url $SEPOLIA_RPC_URL
cast call $TOKEN_ADDRESS "totalSupply()(uint256)" --rpc-url $SEPOLIA_RPC_URL

# 5. 转账测试
cast send $TOKEN_ADDRESS \
  "transfer(address,uint256)(bool)" \
  0x接收地址 \
  1000000000000000000000 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL
```

