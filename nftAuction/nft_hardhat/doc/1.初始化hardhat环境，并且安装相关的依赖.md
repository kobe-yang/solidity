# 初始化 Hardhat 环境并安装相关依赖

## 目录

- [Hardhat 3.0 (viem)](#hardhat-30-viem)
- [Hardhat 2.0 (ethers)](#hardhat-20-ethers)
- [OpenZeppelin 合约安装](#openzeppelin-合约安装)
- [常见问题](#常见问题)

---

## Hardhat 3.0 (viem)

Hardhat 3.0 是最新版本，默认使用 **viem** 作为以太坊交互库。

### 初始化项目

```bash
mkdir my-project
cd my-project
npm init -y
npm install --save-dev hardhat
npx hardhat init
```

选择 `Create a TypeScript project (with Viem)` 选项。

### package.json 示例

```json
{
  "name": "my-hardhat-project",
  "version": "1.0.0",
  "type": "module",
  "devDependencies": {
    "@nomicfoundation/hardhat-ignition": "^3.0.6",
    "@nomicfoundation/hardhat-toolbox-viem": "^5.0.1",
    "@types/node": "^22.19.3",
    "hardhat": "^3.1.0",
    "typescript": "~5.8.0",
    "viem": "^2.43.1"
  }
}
```

### hardhat.config.ts 示例

```typescript
import hardhatToolboxViemPlugin from "@nomicfoundation/hardhat-toolbox-viem";
import { configVariable, defineConfig } from "hardhat/config";

export default defineConfig({
  plugins: [hardhatToolboxViemPlugin],
  solidity: {
    profiles: {
      default: {
        version: "0.8.28",
      },
      production: {
        version: "0.8.28",
        settings: {
          optimizer: {
            enabled: true,
            runs: 200,
          },
        },
      },
    },
  },
  networks: {
    sepolia: {
      type: "http",
      chainType: "l1",
      url: configVariable("SEPOLIA_RPC_URL"),
      accounts: [configVariable("SEPOLIA_PRIVATE_KEY")],
    },
  },
});
```

### 测试示例 (Hardhat 3.0)

Hardhat 3.0 使用 Node.js 内置的测试模块：

```typescript
import assert from "node:assert/strict";
import { describe, it } from "node:test";
import { network } from "hardhat";

describe("MyContract", async function () {
  const { viem } = await network.connect();

  it("Should deploy successfully", async function () {
    const contract = await viem.deployContract("MyContract");
    assert.ok(contract.address);
  });

  it("Should emit event", async function () {
    const contract = await viem.deployContract("MyContract");
    
    await viem.assertions.emitWithArgs(
      contract.write.someFunction(),
      contract,
      "SomeEvent",
      [expectedArg]
    );
  });
});
```

### 运行测试

```bash
npx hardhat test
```

---

## Hardhat 2.0 (ethers)

Hardhat 2.0 使用 **ethers.js** 作为以太坊交互库。

### 初始化项目

```bash
mkdir my-project
cd my-project
npm init -y
npm install --save-dev hardhat
npx hardhat init
```

选择 `Create a TypeScript project` 选项。

### package.json 示例

```json
{
  "name": "my-hardhat-project",
  "version": "1.0.0",
  "devDependencies": {
    "@nomicfoundation/hardhat-toolbox": "^5.0.0",
    "@nomicfoundation/hardhat-ethers": "^3.0.0",
    "@nomicfoundation/hardhat-chai-matchers": "^2.0.0",
    "@typechain/ethers-v6": "^0.5.0",
    "@typechain/hardhat": "^9.0.0",
    "@types/chai": "^4.3.0",
    "@types/mocha": "^10.0.0",
    "@types/node": "^20.0.0",
    "chai": "^4.3.0",
    "ethers": "^6.0.0",
    "hardhat": "^2.22.0",
    "hardhat-gas-reporter": "^1.0.0",
    "solidity-coverage": "^0.8.0",
    "ts-node": "^10.0.0",
    "typechain": "^8.0.0",
    "typescript": "^5.0.0"
  }
}
```

### hardhat.config.ts 示例

```typescript
import { HardhatUserConfig } from "hardhat/config";
import "@nomicfoundation/hardhat-toolbox";

const config: HardhatUserConfig = {
  solidity: "0.8.28",
  networks: {
    sepolia: {
      url: process.env.SEPOLIA_RPC_URL || "",
      accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
    },
  },
};

export default config;
```

### 测试示例 (Hardhat 2.0)

Hardhat 2.0 使用 Mocha + Chai：

```typescript
import { expect } from "chai";
import { ethers } from "hardhat";

describe("MyContract", function () {
  it("Should deploy successfully", async function () {
    const MyContract = await ethers.getContractFactory("MyContract");
    const contract = await MyContract.deploy();
    await contract.waitForDeployment();
    
    expect(await contract.getAddress()).to.be.properAddress;
  });

  it("Should emit event", async function () {
    const MyContract = await ethers.getContractFactory("MyContract");
    const contract = await MyContract.deploy();
    
    await expect(contract.someFunction())
      .to.emit(contract, "SomeEvent")
      .withArgs(expectedArg);
  });
});
```

### 运行测试

```bash
npx hardhat test
```

---

## OpenZeppelin 合约安装

### 安装标准合约

```bash
npm install @openzeppelin/contracts
```

### 安装可升级合约

```bash
npm install @openzeppelin/contracts-upgradeable
```

### 一起安装

```bash
npm install @openzeppelin/contracts @openzeppelin/contracts-upgradeable
```

### 使用示例 - ERC721 NFT

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyNFT is ERC721, ERC721URIStorage, Ownable {
    uint256 private _tokenIdCounter;

    constructor() ERC721("MyNFT", "MNFT") Ownable(msg.sender) {}

    function safeMint(address to, string memory uri) public onlyOwner {
        uint256 tokenId = _tokenIdCounter++;
        _safeMint(to, tokenId);
        _setTokenURI(tokenId, uri);
    }

    // 必须重写的函数
    function tokenURI(uint256 tokenId)
        public
        view
        override(ERC721, ERC721URIStorage)
        returns (string memory)
    {
        return super.tokenURI(tokenId);
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        override(ERC721, ERC721URIStorage)
        returns (bool)
    {
        return super.supportsInterface(interfaceId);
    }
}
```

### 使用示例 - 可升级合约

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

import "@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";

contract MyNFTUpgradeable is Initializable, ERC721Upgradeable, OwnableUpgradeable {
    uint256 private _tokenIdCounter;

    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    function initialize() public initializer {
        __ERC721_init("MyNFT", "MNFT");
        __Ownable_init(msg.sender);
    }

    function safeMint(address to) public onlyOwner {
        uint256 tokenId = _tokenIdCounter++;
        _safeMint(to, tokenId);
    }
}
```

---

## 常见问题

### Q1: 安装依赖时出现版本冲突怎么办？

**错误示例：**
```
npm error ERESOLVE unable to resolve dependency tree
npm error peer hardhat@"^2.0.0" from @nomiclabs/hardhat-ethers@2.2.3
```

**原因：** `@nomiclabs/hardhat-ethers` 是旧版包，只兼容 Hardhat 2.x

**解决方案：**
- 如果使用 Hardhat 3.0：不要安装 `@nomiclabs/hardhat-ethers`，使用 viem
- 如果需要 ethers：降级到 Hardhat 2.0

### Q2: Hardhat 3.0 需要安装 chai-matchers 吗？

**不需要！** `@nomicfoundation/hardhat-toolbox-viem` 已经包含了所有测试功能：
- 使用 Node.js 内置的 `assert` 进行断言
- 使用 `viem.assertions` 进行合约相关断言

### Q3: 如何选择 Hardhat 3.0 还是 2.0？

| 特性 | Hardhat 3.0 (viem) | Hardhat 2.0 (ethers) |
|------|-------------------|---------------------|
| 以太坊库 | viem | ethers.js |
| 测试框架 | Node.js 内置 test | Mocha + Chai |
| 成熟度 | 较新 | 成熟稳定 |
| 社区资源 | 较少 | 丰富 |
| 性能 | 更好 | 良好 |

**建议：**
- 新项目：可以尝试 Hardhat 3.0
- 需要更多社区支持/教程：使用 Hardhat 2.0

---

## 环境变量配置

创建 `.env` 文件（记得添加到 `.gitignore`）：

```env
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_PROJECT_ID
PRIVATE_KEY=your_private_key_here
ETHERSCAN_API_KEY=your_etherscan_api_key
```

安装 dotenv（Hardhat 2.0 需要）：

```bash
npm install dotenv
```

在 `hardhat.config.ts` 开头添加：

```typescript
import "dotenv/config";
```

---

## 常用命令

```bash
# 编译合约
npx hardhat compile

# 运行测试
npx hardhat test

# 运行特定测试文件
npx hardhat test test/MyContract.ts

# 部署合约
npx hardhat ignition deploy ./ignition/modules/MyModule.ts --network sepolia

# 验证合约
npx hardhat verify --network sepolia DEPLOYED_CONTRACT_ADDRESS

# 清理编译缓存
npx hardhat clean

# 查看帮助
npx hardhat help
```

